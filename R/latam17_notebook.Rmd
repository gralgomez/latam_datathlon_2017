---
title: "Datathlon: Health index in Colombia (2005 - 2010)"
output: html_notebook
---
---
title: "Untitled"
author: "Laura Gabrysiak"
date: "6/29/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```
rm(list = ls(all.names = TRUE))
options(encoding = 'UTF-8')
#// Load libraries
library(sp) #// spatial data
library(RColorBrewer)
library(ggplot2)
library(maptools)
library(scales)
library(readr)
library(data.table)

setwd('~/Documents/GitHub/latam_datathlon_2017/R/')

#// Load the data
ind.salud <- read_csv('~/Documents/GitHub/latam_datathlon_2017/data/Indicadores_de_Salud.csv')
#// View(unique(ind.salud[,'nomindicador'])) - 19 indicators 
str(ind.salud)
View(unique(ind.salud[,c('idindicador','nomindicador')]))

#// Measure NA ratio
nacount <- sort(unlist(lapply(ind.salud, function(x) sum(is.na(x))/nrow(ind.salud))))

barplot(sort(nacount), ylab = 'Number of NAs')

#// ind: 
ind <- data.frame(ind.salud[,(2:9)])
ind$nomindicador <- NULL; ind$nomunidad <- NULL; ind$idunidad <- NULL

#// Years - cleaning
years <- subset(ind.salud, select = grep('yea+', names(ind.salud))); 
names(years) = sub('yea','',names(years)); years.rel <- years[16:21]
ind <- cbind(ind,years.rel)

#// Check out the state/municipalities names
library(stringr)
library(stringi)
#//state // decide is numeric or factor
ind$iddepto <- as.numeric(ind$iddepto)
ind$idmpio <- as.numeric(ind$idmpio)

ind$nomdepto <- tolower(ind$nomdepto); 
ind$nomdepto <- stringi::stri_trans_general(ind$nomdepto, 'Latin-ASCII') #// check stri_trans_list()
ind$nomdepto <- gsub('sin informacion', NA, ind$nomdepto)
ind$nomdepto <- gsub('no definido', NA, ind$nomdepto)
ind$nomdepto[ind$iddepto == 88] <- 'san andres'
ind$nomdepto[ind$iddepto == 11] <- 'bogota'
ind$nomdepto[ind$iddepto == 170] <- 'colombia'
ind$nomdepto[ind$iddepto == 54] <- 'n.santander'

ind$nommpio <- tolower(ind$nommpio); 
ind$nommpio <- stringi::stri_trans_general(ind$nommpio, 'Latin-ASCII') #// check stri_trans_list()
head(ind)

nacount.2 <- sort(unlist(lapply(ind, function(x) sum(is.na(x))/nrow(ind)))); barplot(nacount.2)

#// setting up levels
# Level 0 ///////
COL.ind <- subset(ind, ind$iddepto == 170); COL.ind$idmpio <- NULL; COL.ind$nommpio <- NULL; 
unique(COL.ind$idindicador) #// all indicators are given
# // Several instances of the same var and year thus a merge is requiered
COL.ind.all <- as.data.frame(aggregate(COL.ind[4:9], by=list(COL.ind$idindicador),
                     FUN = mean, 
                     na.rm=TRUE)) 
COL.ind.all[is.nan(COL.ind.all)] <- NA
for (i in 1:nrow(COL.ind.all)){
  COL.ind.all$mean[i] <- mean(COL.ind.all[2:7, i], 
                             na.rm = TRUE)  
}

# Level 1 + 2
ind <- subset(ind, ind$iddepto < 170)


#Set up map
#states and COL_Admin2 municipalities
# //source: http://www.gadm.org/country //
COL.m.data <- readShapeSpatial('~/Documents/GitHub/latam_datathlon_2017/GIS_data/COL_adm_shp/COL_adm2.shp')
COL.m.coord <- fortify(COL.m.data)

id <- data.frame(id = unique(COL.m.coord[ , c('id')]))
id[ , 'Porcentaje'] <- runif(nrow(id), 0, 1)

COL.m.coord <- merge(COL.m.coord, id, by = 'id')

mapColDep <- ggplot() +
  geom_polygon(data=ohsColI2, 
               aes(x=long, y=lat,group = group, fill = Porcentaje), 
               colour ='black', size = 0.1) +
  labs(title = 'Colombia', fill = '') +
  labs(x='',y='',title='Colombia') +
  scale_x_continuous(limits=c(-80,-65))+
  scale_y_continuous(limits=c(-5,13) )

mapColDep
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).
